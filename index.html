<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VISTA ‚Äî Image Library + AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f7fb;
      color: #333;
      margin: 0;
      padding: 24px;
      text-align: center;
    }

    h1 {
      margin: 0 0 10px;
      font-size: 32px;
      letter-spacing: 1px;
    }

    .bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
      margin: 10px auto 18px;
    }

    input, select, button {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid #d0d7e2;
      font-size: 14px;
      background: #fff;
      outline: none;
    }

    input {
      min-width: 230px;
    }

    select {
      min-width: 150px;
    }

    #ai-count {
      min-width: 70px;
      max-width: 80px;
      text-align: center;
    }

    button {
      cursor: pointer;
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
    }

    button.primary {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
      box-shadow: 0 4px 10px rgba(0, 123, 255, 0.25);
    }

    button.primary:hover {
      background-color: #0056b3;
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0, 123, 255, 0.35);
    }

    #status {
      min-height: 22px;
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    #gallery {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 520px;
      margin: 10px auto 10px;
      width: 90%;
      max-width: 1000px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 16px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
    }

    #gallery img {
      position: absolute;
      max-width: 92%;
      max-height: 92%;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.25);
      opacity: 0;
      transition: opacity 0.8s ease-in-out;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      object-fit: contain;
    }

    #gallery img.active {
      opacity: 1;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0); }
      to   { transform: rotate(360deg); }
    }

    .catalog-wrapper {
      max-width: 640px;
      margin: 10px auto 18px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #e9edf7;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.05);
      overflow-x: auto;
    }

    .catalog {
      display: flex;
      gap: 6px;
      padding: 2px;
      min-width: max-content;
      justify-content: center;
    }

    .catalog-btn {
      min-width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 999px;
      border: 1px solid #c3cce5;
      background: white;
      font-size: 13px;
      color: #475569;
    }

    .catalog-btn.active {
      background: #007bff;
      border-color: #007bff;
      color: white;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3);
    }

    .ctrls {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .ctrl-btn {
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      color: white;
      background: #2563eb;
    }

    .ctrl-btn.secondary {
      background: #64748b;
    }

    .ctrl-btn.danger {
      background: #e11d48;
    }

    .history {
      width: 90%;
      max-width: 1000px;
      margin: 14px auto 16px;
      padding: 14px 16px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
      text-align: left;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .history-title {
      font-size: 16px;
      font-weight: 700;
      color: #0f172a;
    }

    .history-clear {
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      color: #334155;
      padding: 6px 12px;
      cursor: pointer;
    }

    .history-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .history-card {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 10px;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .history-card-head {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .history-keyword {
      font-weight: 600;
      color: #0f172a;
    }

    .history-meta {
      font-size: 12px;
      color: #64748b;
    }

    .history-thumbs {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .history-thumbs img {
      width: 100%;
      height: 70px;
      border-radius: 8px;
      object-fit: cover;
    }

    .history-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .history-count {
      font-size: 12px;
      color: #475569;
    }

    .history-restore {
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: white;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
    }

    .history-empty {
      color: #94a3b8;
      font-size: 13px;
      padding: 8px 2px;
    }

    .session {
      width: 90%;
      max-width: 1000px;
      margin: 10px auto 24px;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px dashed #cbd5e1;
      background: #f8fafc;
      text-align: left;
      display: grid;
      gap: 12px;
    }

    .session-title {
      font-weight: 700;
      color: #0f172a;
    }

    .session-grid {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 14px;
      align-items: center;
    }

    .session-qr {
      width: 140px;
      height: 140px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      background: white;
      object-fit: cover;
    }

    .session-meta {
      display: grid;
      gap: 6px;
      font-size: 14px;
      color: #475569;
    }

    .session-code {
      font-weight: 700;
      color: #2563eb;
    }

    .session-link a {
      color: #1d4ed8;
      word-break: break-all;
    }

    @media (max-width: 640px) {
      .session-grid {
        grid-template-columns: 1fr;
      }
      .session-qr {
        width: 120px;
        height: 120px;
      }
    }
    /* Diffusion-style reveal animation */
@keyframes diffusionReveal {
  0% {
    filter: blur(30px) brightness(0.6) contrast(0.8);
    opacity: 0.2;
  }
  40% {
    filter: blur(18px) brightness(0.8) contrast(0.9);
    opacity: 0.6;
  }
  80% {
    filter: blur(8px) brightness(1) contrast(1);
    opacity: 0.95;
  }
  100% {
    filter: blur(0px) brightness(1) contrast(1);
    opacity: 1;
  }
}

#unsplash-preview.animate {
  animation: diffusionReveal 1.6s ease-out forwards;
}

    /* =============================
         AI Loading Overlay
    ============================== */
    #ai-loading {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.92);
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 30px;
      z-index: 99999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s ease;
    }

    #ai-loading.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .sketch {
      width: 150px;
      height: 150px;
      background: url('sketch.svg') no-repeat center;
      background-size: contain;
      opacity: 0.8;
      animation: sketchPulse 1.8s ease-in-out infinite;
      filter: invert(1);
    }

    @keyframes sketchPulse {
      0% { opacity: 0.2; transform: scale(0.9); }
      50% { opacity: 1; transform: scale(1.05); }
      100% { opacity: 0.2; transform: scale(0.9); }
    }

    #unsplash-preview {
      width: 360px;
      height: 280px;
      object-fit: cover;
      opacity: 0;
      filter: blur(14px);
      border-radius: 14px;
      transition: opacity 1s, filter 1.6s;
    }

  </style>
</head>

<body>

  <h1>VISTA ‚Äî Image Library + AI</h1>

  <div class="bar">
    <input id="keyword" type="text" placeholder="Enter theme (e.g. dog, future city)" />

    <select id="mode" onchange="onModeChange()">
  <option value="unsplash" selected>Unsplash</option>
  <option value="pexels">Pexels</option>
  <option value="lexica">Lexica (AI Gallery)</option>
  <option value="ai">AI (DALL¬∑E)</option>
  <option value="flux">Flux (Replicate)</option>
</select>


    <input id="ai-count" type="number" min="1" max="10" value="3" />

    <button class="primary" onclick="searchOrGenerate()">Search / Generate</button>
    <button class="secondary" onclick="testAnimation()">Test Animation</button>

  </div>

  <div id="status"></div>

  <div id="gallery"><p>Try searching or generating!</p></div>

  <div class="catalog-wrapper" id="catalog-wrapper" style="display:none;">
    <div class="catalog" id="catalog"></div>
  </div>

  <div class="history" id="history">
    <div class="history-header">
      <div class="history-title">Result history</div>
      <button class="history-clear" onclick="clearHistory()">Clear history</button>
    </div>
    <div class="history-grid" id="history-grid"></div>
  </div>

  <div class="session" id="sessionBox">
    <div class="session-title">Remote control</div>
    <div class="session-grid">
      <img class="session-qr" id="session-qr" alt="QR code" />
      <div class="session-meta">
        <div>Scan the QR code to open the phone remote.</div>
        <div>Short code: <span class="session-code" id="session-code">‚Äî</span></div>
        <div class="session-link"><a id="session-link" href="#" target="_blank">‚Äî</a></div>
      </div>
    </div>
  </div>

  <div class="ctrls">
    <button class="ctrl-btn" onclick="startSlideshow()">‚ñ∂ Play</button>
    <button class="ctrl-btn secondary" onclick="stopSlideshow()">‚èπ Stop</button>
    <button class="ctrl-btn secondary" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
    <button class="ctrl-btn secondary" onclick="downloadCurrent()">‚¨á Download</button>
    <button class="ctrl-btn danger" onclick="clearGallery()">Clear</button>
  </div>

  <!-- AI Loading Overlay -->
  <div id="ai-loading">
    <div class="sketch"></div>
    <p id="loading-text">Creating your image...</p>
    <img id="unsplash-preview" />
  </div>
  

<script>
  /* =====================================================
             FORCE DOWNLOAD (UNSPLASH/PEXELS/LEXICA)
===================================================== */
async function forceDownload(url, filename) {
  try {
    const res = await fetch(url);
    const blob = await res.blob();

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  } catch (err) {
    console.error("Download failed:", err);
    alert("Failed to download image.");
  }
}
/* =====================================================
             TEST AI LOADING ANIMATION
===================================================== */
function testAnimation() {
  showAILoading("test");
}
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    hideAILoading();
  }
});


/* =====================================================
             AI LOADING + UNSPLASH PREVIEW
===================================================== */
let previewTimer = null;

function showAILoading(keyword) {
  document.getElementById("ai-loading").classList.add("visible");
  startUnsplashPreview(keyword);
}

function hideAILoading() {
  document.getElementById("ai-loading").classList.remove("visible");
  clearInterval(previewTimer);
}

async function startUnsplashPreview(keyword) {
  const imgBox = document.getElementById("unsplash-preview");

  try {
    const r = await fetch(
      `${API_BASE}/api/unsplash?q=${encodeURIComponent(keyword)}&page=1`
    );
    const data = await r.json();
    const images = data.images || [];
    if (!images.length) return;

    let index = 0;

    // ÊòæÁ§∫Á¨¨‰∏ÄÂº†
    imgBox.classList.remove("animate");
    void imgBox.offsetWidth;
    imgBox.src = images[0];
    imgBox.classList.add("animate");

    // ÊØè 1.5 ÁßíÂàá‰∏ÄÂº†Âπ∂ÊâßË°å diffusion reveal
    previewTimer = setInterval(() => {
      index = (index + 1) % images.length;

      imgBox.classList.remove("animate");
      void imgBox.offsetWidth;

      imgBox.src = images[index];
      imgBox.classList.add("animate");
    }, 4000);

  } catch (e) {
    console.log(e);
  }
}

/* =====================================================
             YOUR ORIGINAL LOGIC BELOW
===================================================== */
const API_BASE = "https://vista-backend-1-6r3t.onrender.com";
const FRONTEND_BASE = "https://1195898560zyy-del.github.io/vistapj";

let slideIndex = 0;
let slideTimer = null;

let currentKeyword = "";
let currentPage = 1;
let totalPages = 1;
let currentAiSize = "1024x1024";

let sessionID = null;
let sessionCode = null;
let sessionPoll = null;

const HISTORY_KEY = "vista_result_history_v1";
const HISTORY_LIMIT = 5;
const HISTORY_MAX_IMAGES = 9;
const HISTORY_MAX_BYTES = 4000000;

function setStatus(msg) {
  document.getElementById("status").textContent = msg || "";
}

function loadHistory() {
  try {
    const raw = localStorage.getItem(HISTORY_KEY);
    const parsed = raw ? JSON.parse(raw) : [];
    return Array.isArray(parsed) ? parsed : [];
  } catch (err) {
    return [];
  }
}

function saveHistory(history) {
  let trimmed = history.slice(0, HISTORY_LIMIT);
  let json = JSON.stringify(trimmed);
  while (json.length > HISTORY_MAX_BYTES && trimmed.length > 1) {
    trimmed.pop();
    json = JSON.stringify(trimmed);
  }
  localStorage.setItem(HISTORY_KEY, json);
  return trimmed;
}

function buildHistoryEntry(mode, keyword, urls) {
  const kept = [];
  let usedDataUrl = false;
  urls.forEach((url) => {
    if (kept.length >= HISTORY_MAX_IMAGES) return;
    if (url.startsWith("data:image")) {
      if (usedDataUrl) return;
      usedDataUrl = true;
    }
    kept.push(url);
  });
  return {
    id: `${Date.now()}_${Math.random().toString(16).slice(2)}`,
    mode,
    keyword,
    urls: kept,
    total: urls.length,
    ts: Date.now()
  };
}

function addHistory(mode, keyword, urls) {
  const history = loadHistory();
  const entry = buildHistoryEntry(mode, keyword, urls);
  history.unshift(entry);
  const saved = saveHistory(history);
  renderHistory(saved);
}

function clearHistory() {
  localStorage.removeItem(HISTORY_KEY);
  renderHistory([]);
}

function formatHistoryTime(ts) {
  try {
    return new Date(ts).toLocaleString();
  } catch (err) {
    return "";
  }
}

function renderHistory(history = loadHistory()) {
  const grid = document.getElementById("history-grid");
  if (!grid) return;
  grid.innerHTML = "";

  if (!history.length) {
    const empty = document.createElement("div");
    empty.className = "history-empty";
    empty.textContent = "No history yet. Run a search or generate images.";
    grid.appendChild(empty);
    return;
  }

  history.forEach((entry) => {
    const card = document.createElement("div");
    card.className = "history-card";

    const head = document.createElement("div");
    head.className = "history-card-head";

    const keyword = document.createElement("div");
    keyword.className = "history-keyword";
    keyword.textContent = entry.keyword || "(no keyword)";

    const meta = document.createElement("div");
    meta.className = "history-meta";
    const modeLabel = entry.mode || "unknown";
    meta.textContent = `${modeLabel} ¬∑ ${formatHistoryTime(entry.ts)}`;

    head.appendChild(keyword);
    head.appendChild(meta);

    const thumbs = document.createElement("div");
    thumbs.className = "history-thumbs";
    (entry.urls || []).forEach((url) => {
      const img = document.createElement("img");
      img.src = url;
      img.alt = entry.keyword || "history";
      img.loading = "lazy";
      thumbs.appendChild(img);
    });

    const footer = document.createElement("div");
    footer.className = "history-footer";

    const count = document.createElement("span");
    count.className = "history-count";
    const totalText = entry.total && entry.total !== (entry.urls || []).length
      ? `${(entry.urls || []).length}/${entry.total}`
      : `${(entry.urls || []).length}`;
    count.textContent = `${totalText} images`;

    const restore = document.createElement("button");
    restore.className = "history-restore";
    restore.textContent = "Restore";
    restore.addEventListener("click", () => restoreHistory(entry.id));

    footer.appendChild(count);
    footer.appendChild(restore);

    card.appendChild(head);
    card.appendChild(thumbs);
    card.appendChild(footer);
    grid.appendChild(card);
  });
}

function restoreHistory(id) {
  const history = loadHistory();
  const entry = history.find((item) => item.id === id);
  if (!entry || !entry.urls || !entry.urls.length) {
    setStatus("No images found in history.");
    return;
  }

  stopSlideshow();
  const keywordInput = document.getElementById("keyword");
  keywordInput.value = entry.keyword || "";
  const modeSelect = document.getElementById("mode");
  if (entry.mode) {
    modeSelect.value = entry.mode;
    onModeChange();
  }

  const g = document.getElementById("gallery");
  g.innerHTML = "";
  entry.urls.forEach((url, i) => createImg(url, entry.keyword, i === 0));
  buildCatalog(entry.urls.length);
  setActive(0);
  setStatus("Restored from history.");
}

function buildRemoteUrl(id) {
  return `${FRONTEND_BASE}/remote.html?session=${encodeURIComponent(id)}`;
}

function updateSessionUI(url, code) {
  const link = document.getElementById("session-link");
  const codeEl = document.getElementById("session-code");
  const qr = document.getElementById("session-qr");
  if (link) {
    link.href = url;
    link.textContent = url;
  }
  if (codeEl) {
    codeEl.textContent = code || "‚Äî";
  }
  if (qr) {
    qr.src = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(url)}`;
  }
}

async function initSession() {
  try {
    const stored = localStorage.getItem("vista_presenter_session");
    if (stored) {
      const ping = await fetch(`${API_BASE}/api/session/${encodeURIComponent(stored)}`);
      if (ping.ok) {
        sessionID = stored;
        sessionCode = "‚Äî";
        const remoteUrl = buildRemoteUrl(sessionID);
        updateSessionUI(remoteUrl, sessionCode);
        startCommandPolling();
        return;
      }
    }

    const res = await fetch(`${API_BASE}/api/session`, { method: "POST" });
    const data = await res.json();
    sessionID = data.session;
    sessionCode = data.code;
    localStorage.setItem("vista_presenter_session", sessionID);
    const remoteUrl = buildRemoteUrl(sessionID);
    updateSessionUI(remoteUrl, sessionCode);
    startCommandPolling();
  } catch (err) {
    console.error("Session init failed:", err);
  }
}

function startCommandPolling() {
  if (sessionPoll) clearInterval(sessionPoll);
  sessionPoll = setInterval(async () => {
    if (!sessionID) return;
    try {
      const res = await fetch(`${API_BASE}/api/check?session=${sessionID}`);
      const data = await res.json();
      if (data.command) {
        applyRemoteCommand(data.command);
      }
    } catch (err) {
      console.error("Polling error:", err);
    }
  }, 800);
}

function applyRemoteCommand(command) {
  if (!command || !command.type) return;

  if (command.type === "theme") {
    const keywordInput = document.getElementById("keyword");
    keywordInput.value = command.keyword || "";
    searchOrGenerate();
    return;
  }

  if (command.type === "mode") {
    const modeSelect = document.getElementById("mode");
    modeSelect.value = command.mode || "unsplash";
    onModeChange();
    return;
  }

  if (command.type === "play") {
    startSlideshow();
    return;
  }

  if (command.type === "pause") {
    stopSlideshow();
    return;
  }

  if (command.type === "next") {
    setActive(slideIndex + 1);
    return;
  }

  if (command.type === "prev") {
    setActive(slideIndex - 1);
    return;
  }

  if (command.type === "refresh") {
    searchOrGenerate();
    return;
  }

  if (command.type === "clear") {
    clearGallery();
    return;
  }

  if (command.type === "ai_generate") {
    const keywordInput = document.getElementById("keyword");
    const modeSelect = document.getElementById("mode");
    const aiCountInput = document.getElementById("ai-count");

    keywordInput.value = command.keyword || keywordInput.value;
    modeSelect.value = command.mode || "ai";
    onModeChange();
    if (command.count) {
      aiCountInput.value = command.count;
    }
    if (command.size) {
      currentAiSize = command.size;
    }
    searchOrGenerate();
    return;
  }
}

function clearGallery() {
  stopSlideshow();
  document.getElementById("gallery").innerHTML = "<p>Try searching or generating!</p>";
  document.getElementById("catalog").innerHTML = "";
  document.getElementById("catalog-wrapper").style.display = "none";
  setStatus("");
}

function addSpinner() {
  const g = document.getElementById("gallery");
  g.innerHTML = "";
  const s = document.createElement("div");
  s.className = "spinner";
  g.appendChild(s);
}

function removeSpinner() {
  const s = document.querySelector("#gallery .spinner");
  if (s) s.remove();
}

function createImg(src, alt, active = false) {
  const img = document.createElement("img");
  img.src = src;
  img.alt = alt;
  if (active) img.classList.add("active");
  document.getElementById("gallery").appendChild(img);
}

function getImages() {
  return document.querySelectorAll("#gallery img");
}

function updateCatalogActive(i) {
  const btns = document.querySelectorAll(".catalog-btn");
  btns.forEach((b, idx) => {
    b.classList.toggle("active", idx === i);
  });
}

function setActive(i) {
  const imgs = getImages();
  if (!imgs.length) return;
  imgs.forEach(im => im.classList.remove("active"));
  const target = imgs[i % imgs.length];
  target.classList.add("active");
  slideIndex = i % imgs.length;
  updateCatalogActive(slideIndex);
}

function buildCatalog(count) {
  const wrap = document.getElementById("catalog-wrapper");
  const catalog = document.getElementById("catalog");
  catalog.innerHTML = "";

  if (!count || count <= 1) {
    wrap.style.display = "none";
    return;
  }

  wrap.style.display = "block";

  for (let i = 0; i < count; i++) {
    const btn = document.createElement("button");
    btn.className = "catalog-btn";
    btn.textContent = i + 1;
    if (i === 0) btn.classList.add("active");
    btn.addEventListener("click", () => {
      stopSlideshow();
      setActive(i);
    });
    catalog.appendChild(btn);
  }
}

function startSlideshow() {
  const imgs = getImages();
  if (!imgs.length) return;
  stopSlideshow();
  slideIndex = 0;
  setActive(0);
  slideTimer = setInterval(() => {
    setActive(slideIndex + 1);
  }, 3000);
}

function stopSlideshow() {
  if (slideTimer) {
    clearInterval(slideTimer);
    slideTimer = null;
  }
}

function downloadCurrent() {
  const imgs = getImages();
  if (!imgs.length) return;

  const active = [...imgs].find(i => i.classList.contains("active")) || imgs[0];
  const url = active.src;

  const isUnsplash = url.includes("images.unsplash.com");
  const isPexels = url.includes("pexels.com") || url.includes("images.pexels.com");
  const isLexica = url.includes("lexica");

  const filename =
    (isUnsplash ? "unsplash_" :
     isPexels   ? "pexels_"   :
     isLexica   ? "lexica_"   :
                  "ai_") + Date.now() + ".jpg";

  // Âº∫Âà∂‰∏ãËΩΩÁ¨¨‰∏âÊñπÂõæÂ∫ìÔºåAI ÂõæËµ∞ÂéüÁîü‰∏ãËΩΩ
  if (isUnsplash || isPexels || isLexica) {
    forceDownload(url, filename);
  } else {
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }
}


function toggleFullscreen() {
  const gallery = document.getElementById("gallery");
  if (!document.fullscreenElement &&
      !document.webkitFullscreenElement &&
      !document.msFullscreenElement) {

    if (gallery.requestFullscreen) gallery.requestFullscreen();
    else if (gallery.webkitRequestFullscreen) gallery.webkitRequestFullscreen();
    else if (gallery.msRequestFullscreen) gallery.msRequestFullscreen();
  } else {
    if (document.exitFullscreen) document.exitFullscreen();
    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    else if (document.msExitFullscreen) document.msExitFullscreen();
  }
}

function onModeChange() {
  const mode = document.getElementById("mode").value;
  const aiCountInput = document.getElementById("ai-count");
  const needsCount = (mode === "ai" || mode === "flux");
  aiCountInput.disabled = !needsCount;
  aiCountInput.style.opacity = needsCount ? "1" : "0.5";
}

onModeChange();

async function searchOrGenerate() {
  stopSlideshow();

  const keywordInput = document.getElementById("keyword");
  const mode = document.getElementById("mode").value;
  const keyword = keywordInput.value.trim();

  if (!keyword) {
    setStatus("Please enter a keyword.");
    return;
  }

  addSpinner();

  try {
    if (mode === "unsplash") {

      if (keyword !== currentKeyword) {
        currentKeyword = keyword;
        currentPage = 1;
      }

      setStatus("Searching Unsplash... (random)");

      let r = await fetch(
        `${API_BASE}/api/unsplash?q=${encodeURIComponent(keyword)}&random=1`
      );

      let data = await r.json();
      totalPages = data.totalPages || 1;

      if (data.error || data.errors) {
        removeSpinner();
        const errMsg = (data.error && (data.error.message || data.error)) || data.errors;
        setStatus(`Unsplash failed: ${errMsg}`);
        return;
      }

      removeSpinner();

      const results = data.images || [];

      if (!results.length) {
        clearGallery();
        setStatus("No images found.");
        return;
      }

      const g = document.getElementById("gallery");
      g.innerHTML = "";
      results.forEach((url, i) => createImg(url, keyword, i === 0));

      buildCatalog(results.length);
      setStatus(`Unsplash loaded ${results.length} images.`);
      addHistory("unsplash", keyword, results);
      return;
    }
      // ===========================
// PEXELS
// ===========================
if (mode === "pexels") {
  setStatus("Searching Pexels...");

  const r = await fetch(`${API_BASE}/api/pexels?q=${encodeURIComponent(keyword)}&random=1`);
  const data = await r.json();

  removeSpinner();

  if (data.error) {
    clearGallery();
    setStatus(`Pexels failed: ${data.error}`);
    return;
  }

  if (!data.images || !data.images.length) {
    clearGallery();
    setStatus("No Pexels results found.");
    return;
  }

  const g = document.getElementById("gallery");
  g.innerHTML = "";
  data.images.forEach((url, i) => createImg(url, keyword, i === 0));

  buildCatalog(data.images.length);
  setStatus(`Pexels loaded ${data.images.length} images.`);
  addHistory("pexels", keyword, data.images);
  return;
}

  // ===========================
// LEXICA
// ===========================
if (mode === "lexica") {
  if (keyword !== currentKeyword) {
    currentKeyword = keyword;
    currentPage = 1;
  } else {
    currentPage += 1;
  }

  setStatus(`Searching Lexica... (page ${currentPage})`);

  const r = await fetch(
    `${API_BASE}/api/lexica?q=${encodeURIComponent(keyword)}&page=${currentPage}`
  );
  const data = await r.json();

  removeSpinner();

  if (data.error) {
    clearGallery();
    setStatus(`Lexica failed: ${data.error}`);
    return;
  }

  if (!data.images || !data.images.length) {
    clearGallery();
    setStatus("No Lexica results found.");
    return;
  }

  const g = document.getElementById("gallery");
  g.innerHTML = "";
  data.images.forEach((url, i) => createImg(url, keyword, i === 0));

  buildCatalog(data.images.length);
  setStatus(`Lexica page ${currentPage} loaded.`);
  addHistory("lexica", keyword, data.images);
  return;
}

  // ===========================
// FLUX (REPLICATE)
// ===========================
if (mode === "flux") {
  setStatus("Generating Flux images...");
  showAILoading(keyword);

  let count = parseInt(document.getElementById("ai-count").value, 10);
  if (isNaN(count) || count < 1) count = 1;
  if (count > 5) count = 5;

  const r = await fetch(`${API_BASE}/api/replicate`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      prompt: keyword,
      count
    })
  });

  const data = await r.json();
  removeSpinner();
  hideAILoading();

  const images = data.images || [];
  if (!images.length) {
    clearGallery();
    const errMsg = (data.error && (data.error.message || data.error)) || "No images returned.";
    setStatus(`Flux failed: ${errMsg}`);
    return;
  }

  const g = document.getElementById("gallery");
  g.innerHTML = "";
  images.forEach((url, i) => createImg(url, keyword, i === 0));

  buildCatalog(images.length);
  setStatus(`Flux loaded ${images.length} images.`);
  addHistory("flux", keyword, images);
  return;
}

    /* ==========================
     AI MODE ‚Äî Â§öÈ£éÊ†ºÁîüÊàê
========================== */
setStatus("Generating AI images...");
showAILoading(keyword);

let count = parseInt(document.getElementById("ai-count").value, 10);
if (isNaN(count) || count < 1) count = 1;
if (count > 10) count = 10;

/* ‰Ω†ÁöÑÈ£éÊ†ºÊ±† */
const stylePool = [
  "cinematic lighting",
  "digital art, highly detailed",
  "watercolor illustration",
  "isometric style",
  "neon cyberpunk palette",
  "studio photography, depth of field",
  "surreal concept art",
  "minimalist flat design",
  "futuristic sci-fi cityscape",
  "warm sunset color grading"
];

/* üü¶ ÂàõÂª∫ N ‰∏™‰∏çÂêå prompt */
const prompts = Array.from({ length: count }).map(() => {
  const style = stylePool[Math.floor(Math.random() * stylePool.length)];
  return `${keyword}, ${style}`;
});

/* ‚¨á Ë∞ÉÁî®Êñ∞ API */
const r = await fetch(`${API_BASE}/api/generate_batch`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    prompts,
    model: "gpt-image-1",
    size: currentAiSize
  })
});

const data = await r.json();
removeSpinner();
hideAILoading();

if (!data.data || !data.data.length) {
  clearGallery();
  const errMsg = (data.error && (data.error.message || data.error)) || "No images returned.";
  setStatus(`AI failed: ${errMsg}`);
  return;
}

/* ÊèêÂèñ URL */
const urls = data.data.map(
  it => it.url || `data:image/png;base64,${it.b64_json}`
);

/* ÊîæÂÖ• gallery */
const g = document.getElementById("gallery");
g.innerHTML = "";
urls.forEach((u, i) => createImg(u, keyword, i === 0));

buildCatalog(urls.length);
setStatus("AI images generated (multi-style mode).");
addHistory("ai", keyword, urls);

  } catch (err) {
    console.error(err);
    removeSpinner();
    hideAILoading();
    setStatus("Error: " + err.message);
  }
}

renderHistory();
initSession();
</script>

</body>
</html>

