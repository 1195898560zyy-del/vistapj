<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VISTA Remote</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap");

      :root {
        --bg-1: #0f172a;
        --bg-2: #1e293b;
        --accent: #38bdf8;
        --accent-2: #22c55e;
        --card: rgba(255, 255, 255, 0.08);
        --border: rgba(148, 163, 184, 0.3);
        --text: #f8fafc;
        --muted: #cbd5f5;
        --danger: #f43f5e;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #1e40af 0%, #0f172a 55%, #020617 100%);
        color: var(--text);
        min-height: 100vh;
      }

      .container {
        max-width: 540px;
        margin: 0 auto;
        padding: 20px 16px 32px;
        display: grid;
        gap: 16px;
      }

      .header {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 16px;
        border-radius: 16px;
        background: var(--card);
        border: 1px solid var(--border);
        backdrop-filter: blur(8px);
      }

      .title {
        font-size: 22px;
        font-weight: 700;
        letter-spacing: 0.4px;
      }

      .status {
        display: flex;
        flex-wrap: wrap;
        gap: 8px 12px;
        font-size: 14px;
        color: var(--muted);
      }

      .pill {
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(56, 189, 248, 0.18);
        color: var(--text);
        font-size: 12px;
      }

      .section {
        padding: 16px;
        border-radius: 16px;
        background: var(--card);
        border: 1px solid var(--border);
        display: grid;
        gap: 12px;
      }

      .section-title {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--muted);
      }

      .row {
        display: grid;
        gap: 10px;
      }

      label {
        font-size: 13px;
        color: var(--muted);
      }

      input,
      select {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.6);
        color: var(--text);
        font-size: 14px;
      }

      .btn {
        padding: 12px 14px;
        border-radius: 14px;
        border: none;
        background: var(--accent);
        color: #0f172a;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.12s ease, box-shadow 0.2s ease;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 10px 24px rgba(56, 189, 248, 0.35);
      }

      .btn.secondary {
        background: rgba(148, 163, 184, 0.2);
        color: var(--text);
      }

      .btn.danger {
        background: var(--danger);
        color: white;
      }

      .btn-group {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .btn-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }

      .history-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .chip {
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.2);
        font-size: 12px;
        color: var(--text);
        border: 1px solid transparent;
        cursor: pointer;
      }

      .chip:hover {
        border-color: var(--accent);
      }

      .command-status {
        font-size: 13px;
        color: var(--muted);
      }

      .notice {
        font-size: 13px;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <main class="container">
      <div class="header">
        <div class="title">VISTA Remote</div>
        <div class="status">
          <span class="pill" id="conn-pill">Connecting...</span>
          <span>Session: <span id="session-id">â€”</span></span>
        </div>
      </div>

      <section class="section">
        <div class="section-title">Search library</div>
        <div class="row">
          <label for="theme-input">Keyword</label>
          <input id="theme-input" type="text" placeholder="future city, climate classroom..." />
        </div>
        <div class="row">
          <label for="mode-select">Source</label>
          <select id="mode-select">
            <option value="unsplash">Unsplash</option>
            <option value="pexels">Pexels</option>
          </select>
        </div>
        <div class="row">
          <label for="library-ratio">Aspect ratio</label>
          <select id="library-ratio">
            <option value="1:1" selected>1:1</option>
            <option value="4:3">4:3</option>
            <option value="16:9">16:9</option>
            <option value="3:4">3:4</option>
            <option value="9:16">9:16</option>
          </select>
        </div>
        <div class="row">
          <button class="btn" id="apply-theme">Search</button>
        </div>
        <div class="history-chips" id="theme-history"></div>
      </section>

      <section class="section">
        <div class="section-title">AI generate (Flux)</div>
        <div class="row">
          <label for="ai-prompt">Prompt</label>
          <input id="ai-prompt" type="text" placeholder="Describe what to generate..." />
        </div>
        <div class="row">
          <label for="ai-count">Count (1-5)</label>
          <select id="ai-count">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <div class="row">
          <label for="ai-size">Aspect ratio</label>
          <select id="ai-size">
            <option value="1:1" selected>1:1</option>
            <option value="4:3">4:3</option>
            <option value="16:9">16:9</option>
            <option value="3:4">3:4</option>
            <option value="9:16">9:16</option>
          </select>
        </div>
        <div class="row">
          <button class="btn" id="generate">âœ¨ Generate</button>
        </div>
      </section>

      <section class="section">
        <div class="section-title">Controls</div>
        <div class="btn-grid">
          <button class="btn secondary" id="prev">â—€ï¸Ž Prev</button>
          <button class="btn" id="play-toggle">â–¶ï¸Ž Play</button>
          <button class="btn secondary" id="next">â–¶ï¸Ž Next</button>
          <button class="btn danger" id="clear">ðŸ§¹ Clear</button>
        </div>
        <div class="command-status" id="command-status">Ready.</div>
        <div class="notice" id="notice"></div>
      </section>

      <section class="section">
        <div class="section-title">Refine</div>
        <div class="row">
          <label for="refine-input">Refine prompt</label>
          <input id="refine-input" type="text" placeholder="Make it cinematic, add neon lights..." />
        </div>
        <div class="row">
          <button class="btn" id="refine-send">ðŸ§ª Refine</button>
        </div>
      </section>
    </main>

    <script>
      const API_BASE = "https://vista-backend-1-6r3t.onrender.com";
      const THEME_HISTORY_KEY = "vista_theme_history_v1";
      const THEME_HISTORY_LIMIT = 5;
      const GENERATE_COOLDOWN = 30;

      const sessionIdEl = document.getElementById("session-id");
      const connPill = document.getElementById("conn-pill");
      const commandStatus = document.getElementById("command-status");
      const notice = document.getElementById("notice");

      const themeInput = document.getElementById("theme-input");
      const themeHistory = document.getElementById("theme-history");
      const modeSelect = document.getElementById("mode-select");
      const ratioSelect = document.getElementById("library-ratio");
      const aiPrompt = document.getElementById("ai-prompt");
      const aiCount = document.getElementById("ai-count");
      const aiSize = document.getElementById("ai-size");
      const refineInput = document.getElementById("refine-input");

      const btnApplyTheme = document.getElementById("apply-theme");
      const btnPlayToggle = document.getElementById("play-toggle");
      const btnPrev = document.getElementById("prev");
      const btnNext = document.getElementById("next");
      const btnGenerate = document.getElementById("generate");
      const btnClear = document.getElementById("clear");
      const btnRefine = document.getElementById("refine-send");

      let sessionId = null;
      let cooldownTimer = null;
      let isPlaying = false;

      function setConnection(ok, text) {
        connPill.textContent = text;
        connPill.style.background = ok
          ? "rgba(34, 197, 94, 0.2)"
          : "rgba(244, 63, 94, 0.2)";
      }

      function setCommandStatus(text) {
        commandStatus.textContent = text;
      }

      function loadThemeHistory() {
        try {
          const raw = localStorage.getItem(THEME_HISTORY_KEY);
          const list = raw ? JSON.parse(raw) : [];
          return Array.isArray(list) ? list : [];
        } catch (err) {
          return [];
        }
      }

      function saveThemeHistory(keyword) {
        if (!keyword) return;
        const list = loadThemeHistory().filter((item) => item !== keyword);
        list.unshift(keyword);
        const trimmed = list.slice(0, THEME_HISTORY_LIMIT);
        localStorage.setItem(THEME_HISTORY_KEY, JSON.stringify(trimmed));
        renderThemeHistory(trimmed);
      }

      function renderThemeHistory(list = loadThemeHistory()) {
        themeHistory.innerHTML = "";
        list.forEach((keyword) => {
          const chip = document.createElement("button");
          chip.className = "chip";
          chip.textContent = keyword;
          chip.addEventListener("click", () => {
            themeInput.value = keyword;
            sendCommand("theme", { keyword });
          });
          themeHistory.appendChild(chip);
        });
      }

      async function sendCommand(type, payload = {}) {
        if (!sessionId) {
          setCommandStatus("No session. Scan the QR code on the presenter.");
          return;
        }

        setCommandStatus("Sending...");
        try {
          const res = await fetch(`${API_BASE}/api/cmd`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              session: sessionId,
              command: { type, ...payload }
            })
          });
          const data = await res.json();
          if (!res.ok) {
            setConnection(false, "Disconnected");
            setCommandStatus(data.error || "Send failed");
            return;
          }
          setConnection(true, "Connected");
          setCommandStatus("Sent âœ“");
          waitForExecuted(data.id);
        } catch (err) {
          setConnection(false, "Reconnecting...");
          setCommandStatus("Network error");
        }
      }

      async function waitForExecuted(commandId) {
        let attempts = 0;
        const poll = async () => {
          attempts += 1;
          try {
            const res = await fetch(
              `${API_BASE}/api/status?session=${encodeURIComponent(sessionId)}&id=${encodeURIComponent(commandId)}`
            );
            const data = await res.json();
            if (data.status === "executed") {
              setCommandStatus("Executed âœ“");
              return;
            }
          } catch (err) {
            setCommandStatus("Waiting for ack...");
          }
          if (attempts < 12) {
            setTimeout(poll, 500);
          } else {
            setCommandStatus("No ack yet");
          }
        };
        poll();
      }

      function startCooldown() {
        let remaining = GENERATE_COOLDOWN;
        btnGenerate.disabled = true;
        btnGenerate.textContent = `âœ¨ ${remaining}s`;
        cooldownTimer = setInterval(() => {
          remaining -= 1;
          btnGenerate.textContent = `âœ¨ ${remaining}s`;
          if (remaining <= 0) {
            clearInterval(cooldownTimer);
            btnGenerate.disabled = false;
            btnGenerate.textContent = "âœ¨ Generate";
          }
        }, 1000);
      }

      function applyTheme() {
        const keyword = themeInput.value.trim();
        if (!keyword) {
          setCommandStatus("Enter a keyword first.");
          return;
        }
        saveThemeHistory(keyword);
        sendCommand("theme", {
          keyword,
          mode: modeSelect.value,
          ratio: ratioSelect ? ratioSelect.value : "1:1"
        });
      }

      function applyMode() {
        sendCommand("mode", { mode: modeSelect.value });
        updateAiControls();
      }

      btnApplyTheme.addEventListener("click", applyTheme);
      modeSelect.addEventListener("change", applyMode);
      btnPlayToggle.addEventListener("click", () => {
        if (isPlaying) {
          sendCommand("pause");
          isPlaying = false;
          btnPlayToggle.textContent = "â–¶ï¸Ž Play";
        } else {
          sendCommand("play");
          isPlaying = true;
          btnPlayToggle.textContent = "â¸ Pause";
        }
      });
      btnPrev.addEventListener("click", () => sendCommand("prev"));
      btnNext.addEventListener("click", () => sendCommand("next"));
      btnClear.addEventListener("click", () => {
        if (confirm("Clear the gallery?")) sendCommand("clear");
      });
      btnGenerate.addEventListener("click", () => {
        const keyword = aiPrompt.value.trim();
        if (!keyword) {
          setCommandStatus("Enter a generate prompt first.");
          return;
        }
        sendCommand("ai_generate", {
          keyword,
          mode: "flux",
          count: parseInt(aiCount.value, 10),
          size: aiSize.value
        });
        startCooldown();
      });
      btnRefine.addEventListener("click", () => {
        const prompt = refineInput.value.trim();
        if (!prompt) {
          setCommandStatus("Enter a refine prompt first.");
          return;
        }
        sendCommand("refine", { prompt });
      });

      function updateAiControls() {
        aiCount.disabled = false;
        aiSize.disabled = false;
        aiCount.style.opacity = "1";
        aiSize.style.opacity = "1";
        btnGenerate.disabled = false;
      }

      function initSession() {
        const params = new URLSearchParams(window.location.search);
        const fromUrl = params.get("session");
        const stored = localStorage.getItem("vista_session_id");
        sessionId = fromUrl || stored || "";
        if (sessionId) {
          localStorage.setItem("vista_session_id", sessionId);
          sessionIdEl.textContent = sessionId;
          setConnection(true, "Connected");
          notice.textContent = "Ready to control the presenter.";
        } else {
          sessionIdEl.textContent = "â€”";
          setConnection(false, "No session");
          notice.textContent = "Scan the QR code on the presenter screen.";
        }
        renderThemeHistory();
        updateAiControls();
      }

      initSession();
    </script>
  </body>
</html>
